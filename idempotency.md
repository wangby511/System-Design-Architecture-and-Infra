# Idempotency

Update 2021/12/19

## Introduction

Idempotency is a Web API design principle defined as the ability to apply the same operation multiple times without changing the result beyond the first try.

Solution: Clients can safely retry requests that include **an idempotency key** as long as the second request occurs within 24 hours (expiration time) from the first time they receive the key. To perform an idempotent request, provide an additional ```Idempotency-Key: <key>``` header to the request.

An idempotency key is a unique value generated by the client which the server uses to recognize subsequent retries of the same request. Results are only saved if an API endpoint started executing. If it failed validation or conflicted, no idempotent result is saved because no execution. Hence it is safe to retry these requests. The idempotency key can be V4 UUIDs.

Save the resulting status code and body of the first request made for any given idempotency key, regardless of whether it succeeded or failed. Subsequent requests with the same key return the same result, including 500 errors.

All POST requests accept idempotency keys. Sending idempotency keys in GET and DELETE requests has no effect and should be avoided, as these requests are idempotent by definition. (The potential problem with DELETE, which if successful would normally return a 200 (OK) or 204 (No Content), will often return a 404 (Not Found) on subsequent calls.)

Retry with exponential backoff and random jitter(Avoid thundering herd problem).

## Reference

<https://stripe.com/docs/idempotency>

<https://stripe.com/docs/api/idempotent_requests>

<https://www.youtube.com/watch?v=nnMqSQtSZUQ&list=PLy1nL-pvL2M50RmP6ie-gdcSnfOuQCRYk&index=7>

<https://tianpan.co/notes/43-how-to-design-robust-and-predictable-apis-with-idempotency>

## Interview Example

<https://www.1point3acres.com/bbs/thread-748060-1-1.html>

<https://www.1point3acres.com/bbs/thread-814188-1-1.html>
