# Idempotency

Update 2021/12/19

## Introduction

What is idempotency?

For an API request to be idempotent, clients can make the same call repeatedly and the result will be the same. In other words, making multiple identical requests should have the same effect as making a single request.

Idempotency is a Web API design principle defined as the ability to apply the same operation multiple times without changing the result beyond the first try.

Solution: Clients can safely retry requests that include **an idempotency key** as long as the second request occurs within 24 hours (expiration time) from the first time they receive the key. To perform an idempotent request, provide an additional ```Idempotency-Key: <key>``` header to the request.

An idempotency key is a unique value generated by the client which the server uses to recognize subsequent retries of the same request. Results are only saved if an API endpoint started executing. If it failed validation or conflicted, no idempotent result is saved because no execution. Hence it is safe to retry these requests. The idempotency key can be V4 UUIDs.

Save the resulting status code and body of the first request made for any given idempotency key, regardless of whether it succeeded or failed. Subsequent requests with the same key return the same result, including 500 errors.

All POST requests accept idempotency keys. Sending idempotency keys in GET and DELETE requests has no effect and should be avoided, as these requests are idempotent by definition. (The potential problem with DELETE, which if successful would normally return a 200 (OK) or 204 (No Content), will often return a 404 (Not Found) on subsequent calls.)

Retry with exponential back-off and random jitter to avoid thundering herd problem.

## Retry Mechanism

In RESTful APIs, the PUT and DELETE verbs are idempotent.

However, POST may cause "double-charge" problem in payment service. So we use a idempotency key to identify the request.

* If the failure happens before the server, then there is a retry, and the server will see it for the first time, and process it normally.

* If the failure happens in the server, then ACID database will guarantee the transaction by the idempotency key.

* If the failure happens after the serverâ€™s response, then client retries. And the server simply replies with a cached result of the previous operation.

## Reference

[1] <https://stripe.com/docs/idempotency>

[2] <https://stripe.com/docs/api/idempotent_requests>

[3] <https://www.youtube.com/watch?v=nnMqSQtSZUQ&list=PLy1nL-pvL2M50RmP6ie-gdcSnfOuQCRYk&index=7>

[4] <https://tianpan.co/notes/43-how-to-design-robust-and-predictable-apis-with-idempotency>

## Interview Example

[1] <https://www.1point3acres.com/bbs/thread-748060-1-1.html>

[2] <https://www.1point3acres.com/bbs/thread-814188-1-1.html>
